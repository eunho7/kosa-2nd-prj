<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Album Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(to right, #8e44ad, #3498db);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }

        .upload-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            margin: 20px;
            animation: fadeIn 1s ease-in-out;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
        }

        .tag {
            display: inline-block;
            padding: 5px;
            margin: 2px;
            background-color: #e0e0e0;
            border-radius: 3px;
            cursor: default;
        }

        .tag-close {
            margin-left: 5px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .radio-inline {
            display: inline-block;
            margin-right: 10px;
        }
    </style>

    <script src="https://cdn.tiny.cloud/1/ajckn3vmt9uxztu8lb8qylzs2i0zmacodhm03vttrtcs1q88/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#content',
            plugins: 'image code media link',
            toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | image media link code',
            automatic_uploads: true,
            images_upload_handler: function (blobInfo, success, failure) {
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/travel/upload-image');
                xhr.onload = function () {
                    if (xhr.status !== 200) {
                        failure('HTTP Error: ' + xhr.status);
                        return;
                    }

                    let json = JSON.parse(xhr.responseText);
                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    success(json.location);
                };
                xhr.onerror = function () {
                    failure('XHR Error: ' + xhr.status);
                };

                let formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());
                xhr.send(formData);
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('form').addEventListener('submit', function (event) {
                tinymce.get('content').save();
                // Validate form fields
                const title = document.getElementById('title').value.trim();
                const region = document.getElementById('region').value.trim();
                const statDate = document.getElementById('statDate').value.trim();
                const endDate = document.getElementById('endDate').value.trim();
                const content = document.getElementById('content').value.trim();
                const thumbnail = document.getElementById('thumbnail').files.length > 0;
                const isPublic = document.querySelector('input[name="isPublic"]:checked') !== null;

                if (!title || !region || !statDate || !endDate || !thumbnail || !isPublic || !content) {
                    alert('모든 필드를 올바르게 입력해 주세요.');
                    event.preventDefault();  // 폼 제출 방지
                } else {
                    tinymce.get('content').save();
                }
            });
        });
    </script>

    <script>
        function openMapPopup() {
            const albumElement = document.getElementById('albumElement');
            if (albumElement) {
                const albumId = albumElement.dataset.albumId;  // 서버에서 전달된 albumId 값
                if (!albumId) {
                    console.error("albumId is undefined or null.");
                    return;
                }
                const url = `/mapview?albumId=${albumId}`;
                const options = "width=800,height=600,scrollbars=yes,resizable=yes";
                window.open(url, "mapPopup", options);
            } else {
                alert('앨범 ID를 확인할 수 없습니다.');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('.btn-secondary').addEventListener('click', openMapPopup);
        });

        // 태그 추가 관련 스크립트
        function addTag() {
            const input = document.getElementById('themeInput');
            let tagValue = input.value.trim();

            if (tagValue && !document.getElementById(tagValue)) {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.id = tagValue;
                tag.textContent = tagValue;

                const closeBtn = document.createElement('span');
                closeBtn.className = 'tag-close';
                closeBtn.textContent = 'x';
                closeBtn.onclick = function () {
                    tagContainer.removeChild(tag);
                    updateHiddenFields();
                };

                tag.appendChild(closeBtn);
                document.getElementById('tagContainer').appendChild(tag);
                input.value = '';
                updateHiddenFields();
            }
        }

        function updateHiddenFields() {
            const tags = document.querySelectorAll('#tagContainer .tag');
            const hiddenFieldsContainer = document.getElementById('hiddenFieldsContainer');
            hiddenFieldsContainer.innerHTML = '';

            Array.from(tags).forEach((tag, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `travelThemeList[${index}].name`;
                input.value = tag.id;
                hiddenFieldsContainer.appendChild(input);
            });
        }

        document.getElementById('themeInput').addEventListener('keydown', function (event) {
            if (event.key === ' ') {
                event.preventDefault();
                addTag();
            }
        });
    </script>

    <script th:inline="javascript">
        const albumId = /*[[${albumId}]]*/;  // 서버에서 받은 albumId
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('addLocation').addEventListener('click', function () {
                openMapPopup();  // 앨범 ID를 이용하여 팝업 호출
            });
        });
    </script>
</head>
<body>
<div class="upload-container">
    <h1>여행앨범 기록하기</h1>
    <div id="albumElement" th:data-album-id="${albumId}"></div>

    <form th:action="@{/api/travel/create}  " method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" id="title" name="title" class="form-control" required/>
        </div>
        <input type="hidden" id="albumId" name="albumId" th:value="${albumId}" />
        <div class="mb-3">
            <label for="region" class="form-label">지역</label>
            <select id="region" name="region" class="form-select" required>
                <option value="서울">서울</option>
                <option value="인천">인천</option>
                <option value="부산">부산</option>
                <option value="대구">대구</option>
                <option value="광주">광주</option>
                <option value="대전">대전</option>
                <option value="울산">울산</option>
                <option value="세종">세종</option>
                <option value="경기도">경기도</option>
                <option value="강원도">강원도</option>
                <option value="충청도">충청도</option>
                <option value="전라도">전라도</option>
                <option value="경상도">경상도</option>
                <option value="제주도">제주도</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="statDate" class="form-label">여행시작일</label>
            <input type="date" id="statDate" name="statDate" class="form-control" required/>
        </div>

        <div class="mb-3">
            <label for="endDate" class="form-label">여행종료일</label>
            <input type="date" id="endDate" name="endDate" class="form-control" required/>
        </div>

        <div class="mb-3">
            <label for="thumbnail" class="form-label">대표사진</label>
            <input type="file" id="thumbnail" name="thumbnail" class="form-control" accept="image/*" required/>
        </div>

        <!-- TinyMCE 에디터 적용된 내용 입력 -->
        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea id="content" name="content" class="form-control" rows="10"></textarea>
        </div>



        <div class="mb-3">
            <label for="addLocation" class="form-label">위치추가</label>
            <button type="button" class="btn btn-secondary" onclick="openMapPopup()">위치추가</button>
        </div>

        <div class="mb-3">
            <label for="isPublic" class="form-label">공개여부</label>
            <div class="radio-inline">
                <input type="radio" id="public" name="isPublic" value="1" required/>
                <label for="public">공개</label>
            </div>
            <div class="radio-inline">
                <input type="radio" id="private" name="isPublic" value="0" required/>
                <label for="private">비공개</label>
            </div>
        </div>

        <div class="mb-3">
            <label for="themeInput" class="form-label">테마</label>
            <input type="text" id="themeInput" class="form-control"
                   onkeydown="if(event.code === 'Space') { event.preventDefault(); addTag(); }"
                   placeholder="Enter theme and press Space"/>
            <div id="tagContainer" class="mt-2"></div>
        </div>

        <div id="hiddenFieldsContainer"></div>

        <button type="submit" class="btn btn-primary">Upload</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
